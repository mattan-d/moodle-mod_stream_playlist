/**
 * Main.
 *
 * @package
 * @category    admin
 * @copyright  2024 mattandor <mattan@centricapp.co.il>
 * @license     https://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("mod_stream/main",["jquery","jqueryui","core/ajax","core/notification","core/str","core/url"],($,jqui,ajax,notification,str,url)=>({init:function(){var self=this;this.elements=$("#stream-elements"),this.loadingbars=url.imageUrl("icones/loading-bars","stream"),this.selectedIds=($("input[name=identifier]").val()||"").split(",").filter(Boolean),this.videoOrder=[];try{var orderData=$("input[name=video_order]").val();orderData&&(this.videoOrder=JSON.parse(orderData))}catch(e){this.videoOrder=[]}this.currentPage=1,this.itemsPerPage=12,this.totalVideos=0,this.allVideos=[],this.initSortablePlaylist(),$("body").on("click","#stream-elements .list-item-grid",function(){var itemid=$(this).data("itemid").toString(),index=self.selectedIds.indexOf(itemid);if(index>-1){self.selectedIds.splice(index,1),$(this).find(".item").removeClass("selected");var orderIndex=self.videoOrder.indexOf(itemid);orderIndex>-1&&self.videoOrder.splice(orderIndex,1)}else self.selectedIds.push(itemid),$(this).find(".item").addClass("selected"),-1===self.videoOrder.indexOf(itemid)&&self.videoOrder.push(itemid);$("input[name=identifier]").val(self.selectedIds.join(",")),$("input[name=video_order]").val(JSON.stringify(self.videoOrder)),self.updatePlaylistOrder()}),$("body").on("click","#stream-load #stream-sort .btn",function(e){e.preventDefault(),$("#stream-load #stream-sort .btn").removeClass("active"),$(this).toggleClass("active"),self.load()}),$("body").on("click",".btn-upload",e=>{e.preventDefault(),$("#upload_stream").toggle()}),$("#stream-title-search").keyup(()=>{self.load()}),this.load(),window.addEventListener("message",event=>{if(event.data.iframeHeight){var iframe=document.getElementById("upload_stream");iframe&&(iframe.style.height=event.data.iframeHeight+"px")}},!1),window.addEventListener("message",function(event){this.message(event,self)}.bind(this),!1),$("body").on("click","#stream-pagination .page-link[data-page]",function(e){e.preventDefault();var page=parseInt($(this).data("page"));page&&page!==self.currentPage&&(self.currentPage=page,self.renderCurrentPage())})},initSortablePlaylist:function(){0===$("#playlist-container").length?str.get_strings([{key:"selectedvideos",component:"mod_stream"},{key:"dragtoorder",component:"mod_stream"}]).then(strings=>{var containerHtml='<div id="playlist-container"><h4>'+strings[0]+" ("+strings[1]+'):</h4><ul id="sortable-playlist" class="list-group"></ul></div>';$("#stream-load").after(containerHtml),this.initializeSortable(),this.updatePlaylistOrder()}).catch(error=>{$("#stream-load").after('<div id="playlist-container"><h4>Selected Videos (Drag to reorder):</h4><ul id="sortable-playlist" class="list-group"></ul></div>'),this.initializeSortable(),this.updatePlaylistOrder()}):(this.initializeSortable(),this.updatePlaylistOrder())},initializeSortable:function(){setTimeout(()=>{if($("#sortable-playlist").length>0)try{$("#sortable-playlist").sortable({update:(event,ui)=>{this.updateVideoOrderFromPlaylist()},placeholder:"ui-state-highlight list-group-item",cursor:"move",tolerance:"pointer",opacity:.8})}catch(e){console.warn("jQuery UI sortable not available, using fallback drag implementation"),this.initFallbackDragDrop()}},100)},initFallbackDragDrop:function(){var self=this,draggedElement=null;$(document).on("dragstart",".playlist-item",function(e){draggedElement=this,$(this).addClass("dragging"),e.originalEvent.dataTransfer.effectAllowed="move",e.originalEvent.dataTransfer.setData("text/html",this.outerHTML)}),$(document).on("dragend",".playlist-item",function(e){$(this).removeClass("dragging"),draggedElement=null}),$(document).on("dragover",".playlist-item",function(e){if(e.preventDefault(),e.originalEvent.dataTransfer.dropEffect="move",draggedElement!==this){var rect=this.getBoundingClientRect(),midpoint=rect.top+rect.height/2;e.originalEvent.clientY<midpoint?$(this).before(draggedElement):$(this).after(draggedElement),self.updateVideoOrderFromPlaylist()}}),$(document).on("mouseenter",".playlist-item",function(){$(this).attr("draggable","true")})},updatePlaylistOrder:function(){var playlist=$("#sortable-playlist");playlist.empty(),this.videoOrder.forEach(videoId=>{if(this.selectedIds.indexOf(videoId)>-1){var videoElement=$("#video_identifier_"+videoId);if(videoElement.length>0){var title=videoElement.find(".title").text(),thumbnail=videoElement.find("img").attr("src"),playlistItem=$('<li class="list-group-item playlist-item" data-video-id="'+videoId+'" draggable="true"><div class="d-flex align-items-center"><img src="'+thumbnail+'" class="playlist-thumbnail me-3" style="width: 60px; height: 34px; object-fit: cover;"><span class="playlist-title flex-grow-1">'+title+'</span><span class="drag-handle ms-2" style="cursor: move;">⋮⋮</span></div></li>');playlist.append(playlistItem)}}}),this.selectedIds.length>0?$("#playlist-container").show():$("#playlist-container").hide()},updateVideoOrderFromPlaylist:function(){var newOrder=[];$("#sortable-playlist .playlist-item").each(function(){newOrder.push($(this).data("video-id").toString())}),this.videoOrder=newOrder,$("input[name=video_order]").val(JSON.stringify(this.videoOrder))},message:(event,self)=>{if(event.data&&event.data.streamid){var streamid=event.data.streamid.toString();-1===self.selectedIds.indexOf(streamid)&&(self.selectedIds.push(streamid),-1===self.videoOrder.indexOf(streamid)&&self.videoOrder.push(streamid)),$("input[name=identifier]").val(self.selectedIds.join(",")),$("input[name=video_order]").val(JSON.stringify(self.videoOrder)),$("#upload_stream").hide(),self.load()}},load:function(){var sort=$("#stream-load #stream-sort .btn.active").attr("data-name");this.currentPage=1,this.allVideos=[],this.totalVideos=0,this.elements.html('<div style="text-align:center"><img height="80" src="'+this.loadingbars+'" ></div>'),ajax.call([{methodname:"mod_stream_video_list",args:{term:$("#stream-title-search").val(),courseid:$('input[name="course"]').val(),sort:sort}}])[0].then(response=>this.list(response,this)).catch(error=>this.failed(error,this))},failed:(error,self)=>str.get_string("servererror","moodle").then(connectionfailed=>self.elements.html('<div class="alert alert-danger">'+connectionfailed+"</div>")),list:(response,self)=>{if("success"==response.status){if(!response.videos.length)return str.get_string("noresults","mod_stream").then(noresults=>self.elements.html('<div class="alert alert-info">'+noresults+"</div>"));{self.allVideos=response.videos,self.allVideos.sort((a,b)=>{const aSelected=self.selectedIds.indexOf(a.id.toString())>-1,bSelected=self.selectedIds.indexOf(b.id.toString())>-1;return aSelected&&!bSelected?-1:!aSelected&&bSelected?1:0}),self.totalVideos=response.videos.length;const totalPages=Math.ceil(self.totalVideos/self.itemsPerPage),startIndex=(self.currentPage-1)*self.itemsPerPage,endIndex=startIndex+self.itemsPerPage,videosToShow=self.allVideos.slice(startIndex,endIndex);self.elements.html(""),$.each(videosToShow,(key,video)=>{str.get_strings([{key:"views",component:"mod_stream"},{key:"before",component:"mod_stream"}]).then(string=>{var html='<div class="col list-item-grid" data-itemid="'+video.id+'" id="video_identifier_'+video.id+'"><span class="item"><div class="thumbnail"><img src="'+video.thumbnail+'" class="img-fluid img-rounded"><span class="datecreated">'+video.datecreated+'</span><span class="duration">'+video.duration+'</span></div><span class="title">'+video.title+'</span><span class="details">'+video.views+" "+string[0]+' <span class="bubble">●</span> '+string[1]+" "+video.elapsed+"</span></span></div>";return self.elements.append(html),self.selectedIds.indexOf(video.id.toString())>-1&&$("#video_identifier_"+video.id).find(".item").addClass("selected"),self.updatePlaylistOrder(),null}).catch(error=>self.failed(error,self))}),self.updatePagination(totalPages)}}return!0},updatePagination:function(totalPages){var paginationContainer=$("#stream-pagination");if(totalPages<=1)paginationContainer.html("");else{var paginationHtml='<nav aria-label="Video pagination"><ul class="pagination justify-content-center">';this.currentPage>1?paginationHtml+='<li class="page-item"><a class="page-link" href="#" data-page="'+(this.currentPage-1)+'">&laquo; Previous</a></li>':paginationHtml+='<li class="page-item disabled"><span class="page-link">&laquo; Previous</span></li>';var startPage=Math.max(1,this.currentPage-2),endPage=Math.min(totalPages,this.currentPage+2);startPage>1&&(paginationHtml+='<li class="page-item"><a class="page-link" href="#" data-page="1">1</a></li>',startPage>2&&(paginationHtml+='<li class="page-item disabled"><span class="page-link">...</span></li>'));for(var i=startPage;i<=endPage;i++)i===this.currentPage?paginationHtml+='<li class="page-item active"><span class="page-link">'+i+"</span></li>":paginationHtml+='<li class="page-item"><a class="page-link" href="#" data-page="'+i+'">'+i+"</a></li>";endPage<totalPages&&(endPage<totalPages-1&&(paginationHtml+='<li class="page-item disabled"><span class="page-link">...</span></li>'),paginationHtml+='<li class="page-item"><a class="page-link" href="#" data-page="'+totalPages+'">'+totalPages+"</a></li>"),this.currentPage<totalPages?paginationHtml+='<li class="page-item"><a class="page-link" href="#" data-page="'+(this.currentPage+1)+'">Next &raquo;</a></li>':paginationHtml+='<li class="page-item disabled"><span class="page-link">Next &raquo;</span></li>',paginationHtml+="</ul></nav>";var infoHtml='<div class="text-center mb-3"><small class="text-muted">Showing '+((this.currentPage-1)*this.itemsPerPage+1)+"-"+Math.min(this.currentPage*this.itemsPerPage,this.totalVideos)+" of "+this.totalVideos+" videos</small></div>";paginationContainer.html(infoHtml+paginationHtml)}},renderCurrentPage:function(){var self=this;if(0===self.allVideos.length)return;self.allVideos.sort((a,b)=>{const aSelected=self.selectedIds.indexOf(a.id.toString())>-1,bSelected=self.selectedIds.indexOf(b.id.toString())>-1;return aSelected&&!bSelected?-1:!aSelected&&bSelected?1:0});const totalPages=Math.ceil(self.totalVideos/self.itemsPerPage),startIndex=(self.currentPage-1)*self.itemsPerPage,endIndex=startIndex+self.itemsPerPage,videosToShow=self.allVideos.slice(startIndex,endIndex);self.elements.html(""),$.each(videosToShow,(key,video)=>{str.get_strings([{key:"views",component:"mod_stream"},{key:"before",component:"mod_stream"}]).then(string=>{var html='<div class="col list-item-grid" data-itemid="'+video.id+'" id="video_identifier_'+video.id+'"><span class="item"><div class="thumbnail"><img src="'+video.thumbnail+'" class="img-fluid img-rounded"><span class="datecreated">'+video.datecreated+'</span><span class="duration">'+video.duration+'</span></div><span class="title">'+video.title+'</span><span class="details">'+video.views+" "+string[0]+' <span class="bubble">●</span> '+string[1]+" "+video.elapsed+"</span></span></div>";return self.elements.append(html),self.selectedIds.indexOf(video.id.toString())>-1&&$("#video_identifier_"+video.id).find(".item").addClass("selected"),self.updatePlaylistOrder(),null}).catch(error=>self.failed(error,self))}),self.updatePagination(totalPages)}}));

//# sourceMappingURL=main.min.js.map