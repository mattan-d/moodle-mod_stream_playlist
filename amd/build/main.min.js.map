{"version":3,"file":"main.min.js","sources":["../src/main.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Main.\n *\n * @package\n * @category    admin\n * @copyright  2024 mattandor <mattan@centricapp.co.il>\n * @license     https://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine(['jquery', 'jqueryui', 'core/ajax', 'core/notification', 'core/str', 'core/url'], (\n    $,\n    jqui,\n    ajax,\n    notification,\n    str,\n    url,\n) => ({\n  init: function() {\n    var self = this;\n\n    this.elements = $('#stream-elements');\n    this.loadingbars = url.imageUrl('icones/loading-bars', 'stream');\n    this.selectedIds = ($('input[name=identifier]').val() || '').split(',').filter(Boolean);\n    this.videoOrder = [];\n\n    // Initialize video order from existing data\n    try {\n      var orderData = $('input[name=video_order]').val();\n      if (orderData) {\n        this.videoOrder = JSON.parse(orderData);\n      }\n    } catch (e) {\n      this.videoOrder = [];\n    }\n\n    // Initialize sortable playlist\n    this.initSortablePlaylist();\n\n    $('body').on('click', '#stream-elements .list-item-grid', function() {\n      var itemid = $(this).data('itemid').toString();\n      var index = self.selectedIds.indexOf(itemid);\n\n      if (index > -1) {\n        self.selectedIds.splice(index, 1);\n        $(this).find('.item').removeClass('selected');\n        // Remove from video order\n        var orderIndex = self.videoOrder.indexOf(itemid);\n        if (orderIndex > -1) {\n          self.videoOrder.splice(orderIndex, 1);\n        }\n      } else {\n        self.selectedIds.push(itemid);\n        $(this).find('.item').addClass('selected');\n        // Add to video order if not already there\n        if (self.videoOrder.indexOf(itemid) === -1) {\n          self.videoOrder.push(itemid);\n        }\n      }\n      $('input[name=identifier]').val(self.selectedIds.join(','));\n      $('input[name=video_order]').val(JSON.stringify(self.videoOrder));\n      self.updatePlaylistOrder();\n    });\n\n    $('body').on('click', '#stream-load #stream-sort .btn', function(e) {\n      e.preventDefault();\n      $('#stream-load #stream-sort .btn').removeClass('active');\n      $(this).toggleClass('active');\n      self.load();\n    });\n\n    $('body').on('click', '.btn-upload', (e) => {\n      e.preventDefault();\n      $('#upload_stream').toggle();\n    });\n\n    $('#stream-title-search').keyup(() => {\n      self.load();\n    });\n\n    this.load();\n\n    window.addEventListener(\n        'message',\n        (event) => {\n          if (event.data.iframeHeight) {\n            var iframe = document.getElementById('upload_stream');\n            if (iframe) {\n              iframe.style.height = event.data.iframeHeight + 'px';\n            }\n          }\n        },\n        false,\n    );\n\n    // Add event listener to receive messages from iframes\n    window.addEventListener(\n        'message',\n        function(event) {\n          this.message(event, self);\n        }.bind(this),\n        false,\n    );\n  },\n\n  initSortablePlaylist: function() {\n\n\n    // Create playlist container if it doesn't exist\n    if ($('#playlist-container').length === 0) {\n      // Get localized strings first\n      str.get_strings([\n        {key: 'selectedvideos', component: 'mod_stream'},\n        {key: 'dragtoorder', component: 'mod_stream'},\n      ]).then((strings) => {\n        var containerHtml =\n            '<div id=\"playlist-container\">' +\n            '<h4>' +\n            strings[0] +\n            ' (' +\n            strings[1] +\n            '):</h4>' +\n            '<ul id=\"sortable-playlist\" class=\"list-group\"></ul>' +\n            '</div>';\n\n        $('#stream-load').after(containerHtml);\n\n        // Initialize sortable after container is created\n        this.initializeSortable();\n        this.updatePlaylistOrder();\n      }).catch((error) => {\n        // Fallback to English if string loading fails\n        var containerHtml =\n            '<div id=\"playlist-container\">' +\n            '<h4>Selected Videos (Drag to reorder):</h4>' +\n            '<ul id=\"sortable-playlist\" class=\"list-group\"></ul>' +\n            '</div>';\n\n        $('#stream-load').after(containerHtml);\n\n        // Initialize sortable after container is created\n        this.initializeSortable();\n        this.updatePlaylistOrder();\n      });\n    } else {\n      // Container already exists, just initialize sortable\n      this.initializeSortable();\n      this.updatePlaylistOrder();\n    }\n  },\n\n  initializeSortable: function() {\n    // Initialize sortable with a delay to ensure DOM is ready\n    setTimeout(() => {\n      if ($('#sortable-playlist').length > 0) {\n        try {\n          $('#sortable-playlist').sortable({\n            update: (event, ui) => {\n              this.updateVideoOrderFromPlaylist();\n            },\n            placeholder: 'ui-state-highlight list-group-item',\n            cursor: 'move',\n            tolerance: 'pointer',\n            opacity: 0.8,\n          });\n        } catch (e) {\n          console.warn('jQuery UI sortable not available, using fallback drag implementation');\n          this.initFallbackDragDrop();\n        }\n      }\n    }, 100);\n  },\n\n  initFallbackDragDrop: function() {\n    var self = this;\n    var draggedElement = null;\n\n    // Add drag and drop event listeners as fallback\n    $(document).on('dragstart', '.playlist-item', function(e) {\n      draggedElement = this;\n      $(this).addClass('dragging');\n      e.originalEvent.dataTransfer.effectAllowed = 'move';\n      e.originalEvent.dataTransfer.setData('text/html', this.outerHTML);\n    });\n\n    $(document).on('dragend', '.playlist-item', function(e) {\n      $(this).removeClass('dragging');\n      draggedElement = null;\n    });\n\n    $(document).on('dragover', '.playlist-item', function(e) {\n      e.preventDefault();\n      e.originalEvent.dataTransfer.dropEffect = 'move';\n\n      if (draggedElement !== this) {\n        var rect = this.getBoundingClientRect();\n        var midpoint = rect.top + rect.height / 2;\n\n        if (e.originalEvent.clientY < midpoint) {\n          $(this).before(draggedElement);\n        } else {\n          $(this).after(draggedElement);\n        }\n\n        self.updateVideoOrderFromPlaylist();\n      }\n    });\n\n    // Make items draggable\n    $(document).on('mouseenter', '.playlist-item', function() {\n      $(this).attr('draggable', 'true');\n    });\n  },\n\n  updatePlaylistOrder: function() {\n    var playlist = $('#sortable-playlist');\n    playlist.empty();\n\n    // Add selected videos to playlist in order\n    this.videoOrder.forEach((videoId) => {\n      if (this.selectedIds.indexOf(videoId) > -1) {\n        var videoElement = $('#video_identifier_' + videoId);\n        if (videoElement.length > 0) {\n          var title = videoElement.find('.title').text();\n          var thumbnail = videoElement.find('img').attr('src');\n\n          var playlistItem = $(\n              '<li class=\"list-group-item playlist-item\" data-video-id=\"' +\n              videoId +\n              '\" draggable=\"true\">' +\n              '<div class=\"d-flex align-items-center\">' +\n              '<img src=\"' +\n              thumbnail +\n              '\" class=\"playlist-thumbnail me-3\" style=\"width: 60px; height: 34px; object-fit: cover;\">' +\n              '<span class=\"playlist-title flex-grow-1\">' +\n              title +\n              '</span>' +\n              '<span class=\"drag-handle ms-2\" style=\"cursor: move;\">⋮⋮</span>' +\n              '</div>' +\n              '</li>',\n          );\n\n          playlist.append(playlistItem);\n        }\n      }\n    });\n\n    // Show/hide playlist based on selection\n    if (this.selectedIds.length > 0) {\n      $('#playlist-container').show();\n    } else {\n      $('#playlist-container').hide();\n    }\n  },\n\n  updateVideoOrderFromPlaylist: function() {\n    var newOrder = [];\n    $('#sortable-playlist .playlist-item').each(function() {\n      newOrder.push($(this).data('video-id').toString());\n    });\n    this.videoOrder = newOrder;\n    $('input[name=video_order]').val(JSON.stringify(this.videoOrder));\n  },\n\n  message: (event, self) => {\n    // Check if the message contains the streamid\n    if (event.data && event.data.streamid) {\n      var streamid = event.data.streamid.toString();\n      if (self.selectedIds.indexOf(streamid) === -1) {\n        self.selectedIds.push(streamid);\n        if (self.videoOrder.indexOf(streamid) === -1) {\n          self.videoOrder.push(streamid);\n        }\n      }\n      $('input[name=identifier]').val(self.selectedIds.join(','));\n      $('input[name=video_order]').val(JSON.stringify(self.videoOrder));\n      $('#upload_stream').hide();\n      self.load();\n    }\n  },\n\n  load: function() {\n    var sort = $('#stream-load #stream-sort .btn.active').attr('data-name');\n\n    this.elements.html('<div style=\"text-align:center\"><img height=\"80\" src=\"' + this.loadingbars + '\" ></div>');\n\n    ajax.call([\n      {\n        methodname: 'mod_stream_video_list',\n        args: {\n          term: $('#stream-title-search').val(),\n          courseid: $('input[name=\"course\"]').val(),\n          sort: sort,\n        },\n      },\n    ])[0].then((response) => this.list(response, this)).catch((error) => this.failed(error, this));\n  },\n\n  failed: (error, self) =>\n      str.get_string('servererror', 'moodle').\n          then((connectionfailed) => self.elements.html('<div class=\"alert alert-danger\">' + connectionfailed + '</div>')),\n\n  list: (response, self) => {\n    if (response.status == 'success') {\n      if (response.videos.length) {\n        self.elements.html('');\n\n        $.each(response.videos, (key, video) => {\n          str.get_strings([\n            {key: 'views', component: 'mod_stream'},\n            {key: 'before', component: 'mod_stream'},\n          ]).then((string) => {\n            var html =\n                '<div class=\"col list-item-grid\" data-itemid=\"' +\n                video.id +\n                '\" id=\"video_identifier_' +\n                video.id +\n                '\">' +\n                '<span class=\"item\"><div class=\"thumbnail\">' +\n                '<img src=\"' +\n                video.thumbnail +\n                '\" class=\"img-fluid img-rounded\">' +\n                '<span class=\"datecreated\">' +\n                video.datecreated +\n                '</span><span class=\"duration\">' +\n                video.duration +\n                '</span></div><span class=\"title\">' +\n                video.title +\n                '</span><span class=\"details\">' +\n                video.views +\n                ' ' +\n                string[0] +\n                ' <span class=\"bubble\">●</span>' +\n                ' ' +\n                string[1] +\n                ' ' +\n                video.elapsed +\n                '</span></span></div>';\n            self.elements.append(html);\n\n            if (self.selectedIds.indexOf(video.id.toString()) > -1) {\n              $('#video_identifier_' + video.id).find('.item').addClass('selected');\n            }\n\n            // Update playlist after adding videos\n            self.updatePlaylistOrder();\n\n            return null;\n          }).catch((error) => self.failed(error, self));\n        });\n      } else {\n        return str.get_string('noresults', 'mod_stream').\n            then((noresults) => self.elements.html('<div class=\"alert alert-info\">' + noresults + '</div>'));\n      }\n    }\n    return true;\n  },\n}));\n"],"names":["define","$","jqui","ajax","notification","str","url","init","self","this","elements","loadingbars","imageUrl","selectedIds","val","split","filter","Boolean","videoOrder","orderData","JSON","parse","e","initSortablePlaylist","on","itemid","data","toString","index","indexOf","splice","find","removeClass","orderIndex","push","addClass","join","stringify","updatePlaylistOrder","preventDefault","toggleClass","load","toggle","keyup","window","addEventListener","event","iframeHeight","iframe","document","getElementById","style","height","message","bind","length","get_strings","key","component","then","strings","containerHtml","after","initializeSortable","catch","error","setTimeout","sortable","update","ui","updateVideoOrderFromPlaylist","placeholder","cursor","tolerance","opacity","console","warn","initFallbackDragDrop","draggedElement","originalEvent","dataTransfer","effectAllowed","setData","outerHTML","dropEffect","rect","getBoundingClientRect","midpoint","top","clientY","before","attr","playlist","empty","forEach","videoId","videoElement","title","text","thumbnail","playlistItem","append","show","hide","newOrder","each","streamid","sort","html","call","methodname","args","term","courseid","response","list","failed","get_string","connectionfailed","status","videos","noresults","video","string","id","datecreated","duration","views","elapsed"],"mappings":";;;;;;;;AAuBAA,OAAM,kBAAC,CAAC,SAAU,WAAY,YAAa,oBAAqB,WAAY,YAAa,CACrFC,EACAC,KACAC,KACAC,aACAC,IACAC,OACE,CACJC,KAAM,WACJ,IAAIC,KAAOC,KAEXA,KAAKC,SAAWT,EAAE,oBAClBQ,KAAKE,YAAcL,IAAIM,SAAS,sBAAuB,UACvDH,KAAKI,aAAeZ,EAAE,0BAA0Ba,OAAS,IAAIC,MAAM,KAAKC,OAAOC,SAC/ER,KAAKS,WAAa,GAGlB,IACE,IAAIC,UAAYlB,EAAE,2BAA2Ba,MACzCK,YACFV,KAAKS,WAAaE,KAAKC,MAAMF,WAEhC,CAAC,MAAOG,GACPb,KAAKS,WAAa,EACpB,CAGAT,KAAKc,uBAELtB,EAAE,QAAQuB,GAAG,QAAS,mCAAoC,WACxD,IAAIC,OAASxB,EAAEQ,MAAMiB,KAAK,UAAUC,WAChCC,MAAQpB,KAAKK,YAAYgB,QAAQJ,QAErC,GAAIG,OAAS,EAAG,CACdpB,KAAKK,YAAYiB,OAAOF,MAAO,GAC/B3B,EAAEQ,MAAMsB,KAAK,SAASC,YAAY,YAElC,IAAIC,WAAazB,KAAKU,WAAWW,QAAQJ,QACrCQ,YAAc,GAChBzB,KAAKU,WAAWY,OAAOG,WAAY,EAEvC,MACEzB,KAAKK,YAAYqB,KAAKT,QACtBxB,EAAEQ,MAAMsB,KAAK,SAASI,SAAS,aAEU,IAArC3B,KAAKU,WAAWW,QAAQJ,SAC1BjB,KAAKU,WAAWgB,KAAKT,QAGzBxB,EAAE,0BAA0Ba,IAAIN,KAAKK,YAAYuB,KAAK,MACtDnC,EAAE,2BAA2Ba,IAAIM,KAAKiB,UAAU7B,KAAKU,aACrDV,KAAK8B,qBACP,GAEArC,EAAE,QAAQuB,GAAG,QAAS,iCAAkC,SAASF,GAC/DA,EAAEiB,iBACFtC,EAAE,kCAAkC+B,YAAY,UAChD/B,EAAEQ,MAAM+B,YAAY,UACpBhC,KAAKiC,MACP,GAEAxC,EAAE,QAAQuB,GAAG,QAAS,cAAgBF,IACpCA,EAAEiB,iBACFtC,EAAE,kBAAkByC,WAGtBzC,EAAE,wBAAwB0C,MAAM,KAC9BnC,KAAKiC,SAGPhC,KAAKgC,OAELG,OAAOC,iBACH,UACCC,QACC,GAAIA,MAAMpB,KAAKqB,aAAc,CAC3B,IAAIC,OAASC,SAASC,eAAe,iBACjCF,SACFA,OAAOG,MAAMC,OAASN,MAAMpB,KAAKqB,aAAe,KAEpD,IAEF,GAIJH,OAAOC,iBACH,UACA,SAASC,OACPrC,KAAK4C,QAAQP,MAAOtC,KACrB,EAAC8C,KAAK7C,OACP,EAEL,EAEDc,qBAAsB,WAIoB,IAApCtB,EAAE,uBAAuBsD,OAE3BlD,IAAImD,YAAY,CACd,CAACC,IAAK,iBAAkBC,UAAW,cACnC,CAACD,IAAK,cAAeC,UAAW,gBAC/BC,KAAMC,UACP,IAAIC,cACA,oCAEAD,QAAQ,GACR,KACAA,QAAQ,GAJR,mEASJ3D,EAAE,gBAAgB6D,MAAMD,eAGxBpD,KAAKsD,qBACLtD,KAAK6B,wBACJ0B,MAAOC,QAQRhE,EAAE,gBAAgB6D,MALd,qIAQJrD,KAAKsD,qBACLtD,KAAK6B,yBAIP7B,KAAKsD,qBACLtD,KAAK6B,sBAER,EAEDyB,mBAAoB,WAElBG,WAAW,KACT,GAAIjE,EAAE,sBAAsBsD,OAAS,EACnC,IACEtD,EAAE,sBAAsBkE,SAAS,CAC/BC,OAAQA,CAACtB,MAAOuB,MACd5D,KAAK6D,gCAEPC,YAAa,qCACbC,OAAQ,OACRC,UAAW,UACXC,QAAS,IAEZ,CAAC,MAAOpD,GACPqD,QAAQC,KAAK,wEACbnE,KAAKoE,sBACP,GAED,IACJ,EAEDA,qBAAsB,WACpB,IAAIrE,KAAOC,KACPqE,eAAiB,KAGrB7E,EAAEgD,UAAUzB,GAAG,YAAa,iBAAkB,SAASF,GACrDwD,eAAiBrE,KACjBR,EAAEQ,MAAM0B,SAAS,YACjBb,EAAEyD,cAAcC,aAAaC,cAAgB,OAC7C3D,EAAEyD,cAAcC,aAAaE,QAAQ,YAAazE,KAAK0E,UACzD,GAEAlF,EAAEgD,UAAUzB,GAAG,UAAW,iBAAkB,SAASF,GACnDrB,EAAEQ,MAAMuB,YAAY,YACpB8C,eAAiB,IACnB,GAEA7E,EAAEgD,UAAUzB,GAAG,WAAY,iBAAkB,SAASF,GAIpD,GAHAA,EAAEiB,iBACFjB,EAAEyD,cAAcC,aAAaI,WAAa,OAEtCN,iBAAmBrE,KAAM,CAC3B,IAAI4E,KAAO5E,KAAK6E,wBACZC,SAAWF,KAAKG,IAAMH,KAAKjC,OAAS,EAEpC9B,EAAEyD,cAAcU,QAAUF,SAC5BtF,EAAEQ,MAAMiF,OAAOZ,gBAEf7E,EAAEQ,MAAMqD,MAAMgB,gBAGhBtE,KAAK8D,8BACP,CACF,GAGArE,EAAEgD,UAAUzB,GAAG,aAAc,iBAAkB,WAC7CvB,EAAEQ,MAAMkF,KAAK,YAAa,OAC5B,EACD,EAEDrD,oBAAqB,WACnB,IAAIsD,SAAW3F,EAAE,sBACjB2F,SAASC,QAGTpF,KAAKS,WAAW4E,QAASC,UACvB,GAAItF,KAAKI,YAAYgB,QAAQkE,UAAY,EAAG,CAC1C,IAAIC,aAAe/F,EAAE,qBAAuB8F,SAC5C,GAAIC,aAAazC,OAAS,EAAG,CAC3B,IAAI0C,MAAQD,aAAajE,KAAK,UAAUmE,OACpCC,UAAYH,aAAajE,KAAK,OAAO4D,KAAK,OAE1CS,aAAenG,EACf,4DACA8F,QADA,uEAKAI,UALA,oIAQAF,MARA,oFAeJL,SAASS,OAAOD,aAClB,CACF,IAIE3F,KAAKI,YAAY0C,OAAS,EAC5BtD,EAAE,uBAAuBqG,OAEzBrG,EAAE,uBAAuBsG,MAE5B,EAEDjC,6BAA8B,WAC5B,IAAIkC,SAAW,GACfvG,EAAE,qCAAqCwG,KAAK,WAC1CD,SAAStE,KAAKjC,EAAEQ,MAAMiB,KAAK,YAAYC,WACzC,GACAlB,KAAKS,WAAasF,SAClBvG,EAAE,2BAA2Ba,IAAIM,KAAKiB,UAAU5B,KAAKS,YACtD,EAEDmC,QAASA,CAACP,MAAOtC,QAEf,GAAIsC,MAAMpB,MAAQoB,MAAMpB,KAAKgF,SAAU,CACrC,IAAIA,SAAW5D,MAAMpB,KAAKgF,SAAS/E,YACS,IAAxCnB,KAAKK,YAAYgB,QAAQ6E,YAC3BlG,KAAKK,YAAYqB,KAAKwE,WACqB,IAAvClG,KAAKU,WAAWW,QAAQ6E,WAC1BlG,KAAKU,WAAWgB,KAAKwE,WAGzBzG,EAAE,0BAA0Ba,IAAIN,KAAKK,YAAYuB,KAAK,MACtDnC,EAAE,2BAA2Ba,IAAIM,KAAKiB,UAAU7B,KAAKU,aACrDjB,EAAE,kBAAkBsG,OACpB/F,KAAKiC,MACP,GAGFA,KAAM,WACJ,IAAIkE,KAAO1G,EAAE,yCAAyC0F,KAAK,aAE3DlF,KAAKC,SAASkG,KAAK,wDAA0DnG,KAAKE,YAAc,aAEhGR,KAAK0G,KAAK,CACR,CACEC,WAAY,wBACZC,KAAM,CACJC,KAAM/G,EAAE,wBAAwBa,MAChCmG,SAAUhH,EAAE,wBAAwBa,MACpC6F,KAAMA,SAGT,GAAGhD,KAAMuD,UAAazG,KAAK0G,KAAKD,SAAUzG,OAAOuD,MAAOC,OAAUxD,KAAK2G,OAAOnD,MAAOxD,MACzF,EAED2G,OAAQA,CAACnD,MAAOzD,OACZH,IAAIgH,WAAW,cAAe,UAC1B1D,KAAM2D,kBAAqB9G,KAAKE,SAASkG,KAAK,mCAAqCU,iBAAmB,WAE9GH,KAAMA,CAACD,SAAU1G,QACf,GAAuB,WAAnB0G,SAASK,OAAqB,CAChC,IAAIL,SAASM,OAAOjE,OA+ClB,OAAOlD,IAAIgH,WAAW,YAAa,cAC/B1D,KAAM8D,WAAcjH,KAAKE,SAASkG,KAAK,iCAAmCa,UAAY,WA/C1FjH,KAAKE,SAASkG,KAAK,IAEnB3G,EAAEwG,KAAKS,SAASM,OAAQ,CAAC/D,IAAKiE,SAC5BrH,IAAImD,YAAY,CACd,CAACC,IAAK,QAASC,UAAW,cAC1B,CAACD,IAAK,SAAUC,UAAW,gBAC1BC,KAAMgE,SACP,IAAIf,KACA,gDACAc,MAAME,GACN,0BACAF,MAAME,GAHN,yDAOAF,MAAMvB,UAPN,6DAUAuB,MAAMG,YACN,iCACAH,MAAMI,SACN,oCACAJ,MAAMzB,MACN,gCACAyB,MAAMK,MACN,IACAJ,OAAO,GAlBP,kCAqBAA,OAAO,GACP,IACAD,MAAMM,QACN,uBAUJ,OATAxH,KAAKE,SAAS2F,OAAOO,MAEjBpG,KAAKK,YAAYgB,QAAQ6F,MAAME,GAAGjG,aAAe,GACnD1B,EAAE,qBAAuByH,MAAME,IAAI7F,KAAK,SAASI,SAAS,YAI5D3B,KAAK8B,sBAEE,OACN0B,MAAOC,OAAUzD,KAAK4G,OAAOnD,MAAOzD,QAM7C,CACA,OAAO"}
